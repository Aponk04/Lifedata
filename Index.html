<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekam Medis Home Care (Lengkap)</title>
    <style>
        /* CSS Anda tidak diubah, tetap sama */
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; }
        h1, h2 { color: #333; text-align: center; margin-bottom: 20px; }
        .card { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        form label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        form input[type="text"], form input[type="date"], form input[type="time"], form input[type="number"], form textarea, form select { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        form button { background-color: #28a745; color: white; padding: 12px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; box-sizing: border-box; }
        form button:hover { background-color: #218838; }
        ul { list-style: none; padding: 0; }
        #patient-list li { background-color: #e9e9e9; border: 1px solid #ddd; padding: 15px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        #patient-list li button { background-color: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        #patient-list li button:hover { background-color: #0056b3; }
        #medical-record-list li { flex-direction: column; align-items: flex-start; padding: 15px; background-color: #e0f7fa; border-left: 5px solid #00bcd4; margin-bottom: 10px; border-radius: 4px; }
        #medical-record-list li .record-header { font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        #medical-record-list li p { margin: 5px 0; }
        #medical-record-list li strong { color: #00796b; }
        #medical-record-list li span { font-size: 0.9em; color: #666; margin-top: 10px; display: block; text-align: right; }
        #back-to-patients { background-color: #6c757d; margin-top: 20px; }
        #back-to-patients:hover { background-color: #5a6268; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rekam Medis Perawat Home Care</h1>

        <div class="card" id="patient-management-section">
            <div class="card">
                <h2>Tambah Pasien Baru</h2>
                <form id="add-patient-form">
                    <label for="patient-name">Nama Pasien:</label>
                    <input type="text" id="patient-name" required>
                    <label for="patient-dob">Tanggal Lahir:</label>
                    <input type="date" id="patient-dob" required>
                    <label for="patient-address">Alamat:</label>
                    <textarea id="patient-address" rows="3" required></textarea>
                    <button type="submit">Tambah Pasien</button>
                </form>
            </div>
            <div class="card">
                <h2>Daftar Pasien</h2>
                <ul id="patient-list"><li>Memuat daftar pasien...</li></ul>
            </div>
        </div>

        <div class="card" id="medical-record-section" style="display: none;">
            <h2>Catatan Kunjungan untuk: <span id="current-patient-name"></span></h2>
            <form id="add-medical-record-form">
                
                <div class="form-grid">
                    <div>
                        <label for="visit-date">Tanggal Kunjungan:</label>
                        <input type="date" id="visit-date" required>
                    </div>
                    <div>
                        <label for="visit-time">Jam Kunjungan:</label>
                        <input type="time" id="visit-time" required>
                    </div>
                </div>

                <hr>
                <h3>Pemeriksaan Tanda-Tanda Vital (TTV)</h3>
                <div class="form-grid">
                    <div>
                        <label for="blood-pressure">Tekanan Darah (mmHg):</label>
                        <input type="text" id="blood-pressure" placeholder="Contoh: 120/80">
                    </div>
                    <div>
                        <label for="temperature">Suhu (Â°C):</label>
                        <input type="number" step="0.1" id="temperature" placeholder="Contoh: 36.5">
                    </div>
                    <div>
                        <label for="pulse">Nadi (x/menit):</label>
                        <input type="number" id="pulse" placeholder="Contoh: 80">
                    </div>
                    <div>
                        <label for="respiration">Pernapasan (x/menit):</label>
                        <input type="number" id="respiration" placeholder="Contoh: 20">
                    </div>
                </div>

                <hr>
                <h3>Dokumentasi SOAP</h3>
                <label for="soap-s"><strong>S (Subjektif):</strong> Keluhan Pasien</label>
                <textarea id="soap-s" rows="3" required placeholder="Apa yang dikatakan pasien tentang kondisinya?"></textarea>

                <label for="soap-o"><strong>O (Objektif):</strong> Hasil Pengamatan & Pemeriksaan</label>
                <textarea id="soap-o" rows="4" required placeholder="Data hasil TTV, kondisi luka, tingkat kesadaran, dll."></textarea>

                <label for="soap-a"><strong>A (Assessment):</strong> Analisis / Diagnosa Keperawatan</label>
                <textarea id="soap-a" rows="3" required placeholder="Masalah keperawatan yang ditemukan. Contoh: Nyeri akut, risiko infeksi."></textarea>

                <label for="soap-p"><strong>P (Planning):</strong> Perencanaan & Intervensi</label>
                <textarea id="soap-p" rows="4" required placeholder="Tindakan yang telah dan akan dilakukan. Contoh: Memberikan obat, edukasi keluarga."></textarea>

                <hr>
                <label for="medication-notes">Catatan Pemberian Obat:</label>
                <textarea id="medication-notes" rows="3" placeholder="Obat yang diberikan, dosis, dan jam pemberian."></textarea>

                <button type="submit">Simpan Catatan Kunjungan</button>
            </form>

            <h3 style="margin-top: 30px;">Riwayat Kunjungan</h3>
            <ul id="medical-record-list"></ul>
            <button id="back-to-patients">Kembali ke Daftar Pasien</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyBNlEqwNBYi7uYdDy4iXd7sh1JX4PjIk5M",
            authDomain: "lifedata-9a38d.firebaseapp.com",
            projectId: "lifedata-9a38d",
            storageBucket: "lifedata-9a38d.firebasestorage.app",
            messagingSenderId: "85081493262",
            appId: "1:85081493262:web:61201bacb087fc34cc915f"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referensi Elemen HTML
        const addPatientForm = document.getElementById('add-patient-form');
        const patientNameInput = document.getElementById('patient-name');
        const patientDobInput = document.getElementById('patient-dob');
        const patientAddressTextarea = document.getElementById('patient-address');
        const patientList = document.getElementById('patient-list');
        const patientManagementSection = document.getElementById('patient-management-section');
        const medicalRecordSection = document.getElementById('medical-record-section');
        const currentPatientNameSpan = document.getElementById('current-patient-name');
        const addMedicalRecordForm = document.getElementById('add-medical-record-form');
        const medicalRecordList = document.getElementById('medical-record-list');
        const backToPatientsButton = document.getElementById('back-to-patients');

        let currentPatientId = null;

        // --- FUNGSI PASIEN (Tidak Banyak Berubah) ---

        addPatientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, "patients"), {
                    name: patientNameInput.value,
                    dob: patientDobInput.value,
                    address: patientAddressTextarea.value,
                    createdAt: serverTimestamp()
                });
                alert('Pasien berhasil ditambahkan!');
                addPatientForm.reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert('Gagal menambahkan pasien.');
            }
        });

        const displayPatients = () => {
            const q = query(collection(db, "patients"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                patientList.innerHTML = '';
                if (snapshot.empty) {
                    patientList.innerHTML = '<li>Belum ada pasien terdaftar.</li>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const patient = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span><strong>${patient.name}</strong><br><small>Lahir: ${patient.dob}</small></span>
                        <button data-id="${doc.id}" data-name="${patient.name}">Lihat Catatan</button>
                    `;
                    patientList.appendChild(li);
                });
            });
        };

        patientList.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentPatientId = e.target.dataset.id;
                currentPatientNameSpan.textContent = e.target.dataset.name;
                patientManagementSection.style.display = 'none';
                medicalRecordSection.style.display = 'block';
                // Set tanggal & waktu kunjungan ke nilai saat ini
                document.getElementById('visit-date').valueAsDate = new Date();
                document.getElementById('visit-time').value = new Date().toTimeString().slice(0,5);
                displayMedicalRecords(currentPatientId);
            }
        });

        // --- FUNGSI CATATAN MEDIS (TELAH DIPERBARUI) ---

        // Menambah Catatan Medis Lengkap
        addMedicalRecordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentPatientId) return alert('Pilih pasien terlebih dahulu.');

            // Menggabungkan tanggal dan waktu menjadi satu objek Date untuk timestamp
            const visitDate = document.getElementById('visit-date').value;
            const visitTime = document.getElementById('visit-time').value;
            const visitTimestamp = new Date(`${visitDate}T${visitTime}`);

            // Mengambil semua data dari form
            const recordData = {
                patientId: currentPatientId,
                timestamp: visitTimestamp,
                ttv: {
                    blood_pressure: document.getElementById('blood-pressure').value,
                    temperature: document.getElementById('temperature').value,
                    pulse: document.getElementById('pulse').value,
                    respiration: document.getElementById('respiration').value,
                },
                soap: {
                    s: document.getElementById('soap-s').value,
                    o: document.getElementById('soap-o').value,
                    a: document.getElementById('soap-a').value,
                    p: document.getElementById('soap-p').value,
                },
                medication_notes: document.getElementById('medication-notes').value,
                createdAt: serverTimestamp() // Untuk pelacakan internal
            };

            try {
                await addDoc(collection(db, "medicalRecords"), recordData);
                alert('Catatan kunjungan berhasil disimpan!');
                addMedicalRecordForm.reset();
                // Set tanggal & waktu kunjungan kembali ke nilai saat ini untuk entri berikutnya
                document.getElementById('visit-date').valueAsDate = new Date();
                document.getElementById('visit-time').value = new Date().toTimeString().slice(0,5);
            } catch (err) {
                console.error("Error adding medical record: ", err);
                alert('Gagal menyimpan catatan. Lihat konsol untuk detail.');
            }
        });

        // Menampilkan Catatan Medis Lengkap
        const displayMedicalRecords = (patientId) => {
            const q = query(collection(db, "medicalRecords"), where("patientId", "==", patientId), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                medicalRecordList.innerHTML = '';
                if (snapshot.empty) {
                    medicalRecordList.innerHTML = '<li>Belum ada riwayat kunjungan untuk pasien ini.</li>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const record = doc.data();
                    const visitDate = record.timestamp.toDate();
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="record-header">Kunjungan: ${visitDate.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} - ${visitDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</div>
                        
                        <p><strong>TTV:</strong> Tek. Darah: ${record.ttv.blood_pressure || '-'} mmHg, Suhu: ${record.ttv.temperature || '-'} Â°C, Nadi: ${record.ttv.pulse || '-'} x/m, Pernapasan: ${record.ttv.respiration || '-'} x/m</p>
                        
                        <p><strong>S (Subjektif):</strong> ${record.soap.s}</p>
                        <p><strong>O (Objektif):</strong> ${record.soap.o}</p>
                        <p><strong>A (Assessment):</strong> ${record.soap.a}</p>
                        <p><strong>P (Planning):</strong> ${record.soap.p}</p>
                        
                        ${record.medication_notes ? `<p><strong>Catatan Obat:</strong> ${record.medication_notes}</p>` : ''}
                    `;
                    medicalRecordList.appendChild(li);
                });
            });
        };

        // Fungsi Tombol Kembali
        backToPatientsButton.addEventListener('click', () => {
            currentPatientId = null;
            patientManagementSection.style.display = 'block';
            medicalRecordSection.style.display = 'none';
        });

        // Inisialisasi awal
        displayPatients();
    </script>
</body>
</html>
