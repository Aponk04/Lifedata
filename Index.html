<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekam Medis Home Care (Single File)</title>

    <style>
        /* style.css content goes here */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        form input[type="text"],
        form input[type="date"],
        form textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        form button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        form button:hover {
            background-color: #218838;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li {
            background-color: #e9e9e9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        ul li button {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        ul li button:hover {
            background-color: #0056b3;
        }

        #medical-record-list li {
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
            background-color: #e0f7fa;
            border-left: 5px solid #00bcd4;
        }

        #medical-record-list li span {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        #back-to-patients {
            background-color: #6c757d;
            margin-top: 20px;
        }

        #back-to-patients:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rekam Medis Perawat Home Care</h1>

        <div class="card">
            <h2>Tambah Pasien Baru</h2>
            <form id="add-patient-form">
                <label for="patient-name">Nama Pasien:</label>
                <input type="text" id="patient-name" required>

                <label for="patient-dob">Tanggal Lahir:</label>
                <input type="date" id="patient-dob" required>

                <label for="patient-address">Alamat:</label>
                <textarea id="patient-address" rows="3" required></textarea>

                <button type="submit">Tambah Pasien</button>
            </form>
        </div>

        <div class="card">
            <h2>Daftar Pasien</h2>
            <ul id="patient-list">
                <li>Memuat daftar pasien...</li>
            </ul>
        </div>

        <div class="card" id="medical-record-section" style="display: none;">
            <h2>Catatan Medis untuk Pasien: <span id="current-patient-name"></span></h2>
            <form id="add-medical-record-form">
                <label for="medical-record-note">Catatan:</label>
                <textarea id="medical-record-note" rows="5" required></textarea>
                <button type="submit">Tambah Catatan</button>
            </form>

            <h3>Riwayat Catatan</h3>
            <ul id="medical-record-list">
                </ul>
            <button id="back-to-patients">Kembali ke Daftar Pasien</button>
        </div>
    </div>

    <script type="module">
        // script.js content goes here
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNlEqwNBYi7uYdDy4iXd7sh1JX4PjIk5M",
            authDomain: "lifedata-9a38d.firebaseapp.com",
            projectId: "lifedata-9a38d",
            storageBucket: "lifedata-9a38d.firebasestorage.app",
            messagingSenderId: "85081493262",
            appId: "1:85081493262:web:61201bacb087fc34cc915f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get references to HTML elements
        const addPatientForm = document.getElementById('add-patient-form');
        const patientNameInput = document.getElementById('patient-name');
        const patientDobInput = document.getElementById('patient-dob');
        const patientAddressTextarea = document.getElementById('patient-address');
        const patientList = document.getElementById('patient-list');

        const medicalRecordSection = document.getElementById('medical-record-section');
        const currentPatientNameSpan = document.getElementById('current-patient-name');
        const addMedicalRecordForm = document.getElementById('add-medical-record-form');
        const medicalRecordNoteTextarea = document.getElementById('medical-record-note');
        const medicalRecordList = document.getElementById('medical-record-list');
        const backToPatientsButton = document.getElementById('back-to-patients');

        let currentPatientId = null;

        // --- Fungsi untuk Pasien ---

        // Tambah Pasien Baru
        addPatientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = patientNameInput.value;
            const dob = patientDobInput.value;
            const address = patientAddressTextarea.value;

            try {
                await addDoc(collection(db, "patients"), {
                    name: name,
                    dob: dob,
                    address: address,
                    createdAt: new Date()
                });
                alert('Pasien berhasil ditambahkan!');
                addPatientForm.reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert('Gagal menambahkan pasien. Silakan coba lagi.');
            }
        });

        // Menampilkan daftar pasien secara real-time
        const displayPatients = () => {
            onSnapshot(collection(db, "patients"), (snapshot) => {
                patientList.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    patientList.innerHTML = '<li>Belum ada pasien yang terdaftar.</li>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const patient = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span><strong>${patient.name}</strong><br>
                        Tgl Lahir: ${patient.dob}<br>
                        Alamat: ${patient.address}</span>
                        <button data-id="${doc.id}" data-name="${patient.name}">Lihat Catatan</button>
                    `;
                    patientList.appendChild(li);
                });
            });
        };

        // Tangani klik pada tombol "Lihat Catatan" pasien
        patientList.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentPatientId = e.target.dataset.id;
                currentPatientNameSpan.textContent = e.target.dataset.name;
                document.querySelector('.card:nth-child(1)').style.display = 'none'; // Sembunyikan form tambah pasien
                document.querySelector('.card:nth-child(2)').style.display = 'none'; // Sembunyikan daftar pasien
                medicalRecordSection.style.display = 'block'; // Tampilkan bagian catatan medis
                displayMedicalRecords(currentPatientId);
            }
        });

        // --- Fungsi untuk Catatan Medis ---

        // Tambah Catatan Medis
        addMedicalRecordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentPatientId) {
                alert('Pilih pasien terlebih dahulu.');
                return;
            }
            const note = medicalRecordNoteTextarea.value;

            try {
                await addDoc(collection(db, "medicalRecords"), {
                    patientId: currentPatientId,
                    note: note,
                    timestamp: new Date()
                });
                alert('Catatan medis berhasil ditambahkan!');
                addMedicalRecordForm.reset();
            } catch (e) {
                console.error("Error adding medical record: ", e);
                alert('Gagal menambahkan catatan medis. Silakan coba lagi.');
            }
        });

        // Menampilkan catatan medis pasien tertentu secara real-time
        const displayMedicalRecords = (patientId) => {
            const q = query(collection(db, "medicalRecords"),
                            where("patientId", "==", patientId),
                            orderBy("timestamp", "desc")); // Urutkan dari yang terbaru

            onSnapshot(q, (snapshot) => {
                medicalRecordList.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    medicalRecordList.innerHTML = '<li>Belum ada catatan medis untuk pasien ini.</li>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const record = doc.data();
                    const li = document.createElement('li');
                    const date = record.timestamp.toDate(); // Mengubah Timestamp Firebase ke objek Date
                    li.innerHTML = `
                        <p>${record.note}</p>
                        <span>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                    `;
                    medicalRecordList.appendChild(li);
                });
            });
        };

        // Kembali ke daftar pasien
        backToPatientsButton.addEventListener('click', () => {
            currentPatientId = null;
            document.querySelector('.card:nth-child(1)').style.display = 'block'; // Tampilkan form tambah pasien
            document.querySelector('.card:nth-child(2)').style.display = 'block'; // Tampilkan daftar pasien
            medicalRecordSection.style.display = 'none'; // Sembunyikan bagian catatan medis
        });

        // Panggil fungsi untuk menampilkan pasien saat halaman dimuat
        displayPatients();
    </script>
</body>
</html>
